<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />

    <title>From JavaScript to TypeScript</title>

    <link rel="stylesheet" href="dist/reset.css" />
    <link rel="stylesheet" href="dist/reveal.css" />
    <link rel="stylesheet" href="dist/theme/white.css" />

    <!-- Theme used for syntax highlighted code -->
    <link rel="stylesheet" href="plugin/highlight/monokai.css" />

    <style>
      code {
        border: 1px solid #333;
        padding-left: 10px;
        padding-right: 10px;
      }

      /*
      pre.hide-completely {
        display: none;
      }
      pre.hide-completely.current-fragment {
        display: block;
      }

       */
    </style>
  </head>
  <body>
    <div class="reveal">
      <div class="slides">
        <section>
          <h2>8 months ago...</h2>
          <ul>
            <li>Starting a new job</li>
            <li class="fragment">
              Main project is 10 years old
              <span
                style="text-align: center; display: inline-block; width: 100%"
                ><img
                  alt="jurassik park gate"
                  src="img/jurassik.jpg"
                  style="width: 300px"
              /></span>
            </li>
            <li class="fragment">Migration to TS started...</li>
            <li class="fragment">...and never finished</li>
          </ul>
        </section>

        <section>
          <h2>Who am I?</h2>
          <ul
            style="
              display: inline-block;
              width: 600px;
              vertical-align: top;
              position: relative;
            "
          >
            <li>Beno√Æt Lemoine</li>
            <li>
              <a href="https://lemoine-benoit.medium.com/"
                >https://lemoine-benoit.medium.com/</a
              >
            </li>

            <li>
              <a href="https://twitter.com/benoit_lemoine">@benoit_lemoine</a>
            </li>
            <li class="fragment">
              I have around 500 files to migrate in TS...
            </li>
            <li class="fragment">...and 3500 strict errors to fix</li>
          </ul>
          <img
            style="display: inline-block; width: 250px; vertical-align: top"
            src="img/Moloch.png"
            alt="Most beautiful animal in the world: the Moloch (aka. thorny devil)"
          />
        </section>

        <section>
          <h1>
            From JavaScript<br />
            to<br />
            strict TypeScript
          </h1>
        </section>

        <section>
          <h2>Migration in 2 steps</h2>
          <ul>
            <li>JavaScript to lenient TypeScript</li>
            <li>lenient TypeScript to strict TypeScript</li>
          </ul>
        </section>

        <section>
          <h2>Lenient? Strict?</h2>

          <ul>
            <li class="fragment">
              Massive usage of <code>any</code> and
              <code>@ts-expect-error</code>
            </li>
            <li class="fragment">
              Non strict configuration (<code>noImplicitAny</code>,
              <code>strictNullChecks</code>, etc.)
            </li>
          </ul>
        </section>

        <section>
          <h2>Any?</h2>
          <pre><code data-trim class="typescript">
function getAge(a) {  // a is implicitly any
    return Math.floor(
      (Date.now() - new Date(a.birthDate).getTime()
    ) / (86400 * 1000))
}
getName({birthdate: '2021-12-17'}) // returns NaN
            </code></pre>
        </section>

        <section>
          <h2>ts-expect-error?</h2>
          <pre><code data-trim class="typescript">
function getAge(a: Date) {
    // The right-hand side of an arithmetic operation
    // must be of type 'any', 'number', 'bigint' or an enum type.
    return Math.floor(
      (Date.now() - new Date(a.birthDate)
    ) / (86400 * 1000))
}

            </code></pre>
          <pre class="fragment"><code data-trim class="typescript">
function getAge(a: Date) {
    return Math.floor(
      // @ts-expect-error
      (Date.now() - new Date(a.birthDate)
    ) / (86400 * 1000))
}
            </code></pre>
        </section>

        <section>
          <h2>JS to lenient TS</h2>
          <ul>
            <li>Progressive approach</li>
            <li>Big bang mode</li>
          </ul>
        </section>

        <section>
          <h2>Progressive approach</h2>
          <ul>
            <li class="fragment">
              <code>npm install --save-dev typescript </code>
            </li>
            <li class="fragment">Add a <code>tsconfig.json</code> file</li>
            <li class="fragment">
              Add the option <code>"allowJS": true</code>
            </li>
            <li class="fragment">Migrate files one by one</li>
            <li class="fragment">
              Each file can be done with any level of strictness we want
            </li>
          </ul>
        </section>

        <section>
          <h2>Tips & Tricks</h2>
          <ul>
            <li class="fragment">
              Favor <code>unknown</code> over <code>any</code>
            </li>
            <li class="fragment">
              Favor <code>@ts-expect-error</code> over <code>@ts-ignore</code>
            </li>
            <li class="fragment">
              Minimize casts (eg. <code>as unknown as User</code>)
            </li>
            <li class="fragment">
              Good time to update the code to modern idioms
            </li>
          </ul>
        </section>

        <section data-transition="none">
          <h2>TS is not JS</h2>

          <pre class=""><code class="javascript" data-trim>
function User(birthdate) {
    this.birthdate = birthdate;
}

User.prototype.getAge = function() {
    var yearDuration = 24 * 60 * 60 * 1000 * 365
    return Math.floor(
      (Date.now() - this.birthdate.getTime()) / yearDuration
    );
}

module.exports = User
                  </code></pre>
        </section>

        <section data-transition="none">
          <h2>TS is not JS</h2>

          <pre class=""><code class="typescript" data-trim>
export class User {
  constructor(public birthdate: Date){}

  getAge(): number {
    const yearDuration = 24 * 60 * 60 * 1000 * 365
    return Math.floor(
      (Date.now() - this.birthdate.getTime()) / yearDuration
    );
  }
}
                  </code></pre>
        </section>

        <section data-transition="none">
          <h2>TS is not JS</h2>
          <pre class=""><code class="typescript" data-trim>
function addFoo(arr = []) {


    arr.push('foo');
    return arr;
}
              </code></pre>
        </section>

        <section data-transition="none">
          <h2>TS is not JS</h2>
          <pre class=""><code class="typescript" data-trim>
function addFoo(arr = []) {
// Argument of type 'string' is not assignable
//   to parameter of type 'never'.
    arr.push('foo');
    return arr;
}
              </code></pre>
        </section>
        <section data-transition="none">
          <h2>TS is not JS</h2>
          <pre class=""><code class="typescript" data-trim>
function addFoo(arr: string[] = []) {


    arr.push('foo');
    return arr;
}
              </code></pre>
        </section>

        <section data-transition="none">
          <h2>TS is not JS</h2>
          <pre class=""><code class="javascript" data-trim>
const obj = {};

obj.age = 12;
              </code></pre>
        </section>

        <section data-transition="none">
          <h2>TS is not JS</h2>
          <pre class=""><code class="javascript" data-trim>
const obj = {};
// Property 'age' does not exist on type '{}'
obj.age = 12;
              </code></pre>
        </section>

        <section data-transition="none">
          <h2>TS is not JS</h2>
          <pre class=""><code class="javascript" data-trim>
const obj: {age?: number} = {};

obj.age = 12;
              </code></pre>
          <div class="fragment">
            <p>Or even better...</p>
            <pre><code class="javascript" data-trim>
const obj = {age:12};

              </code></pre>
          </div>
        </section>

        <section>
          <h2>Big bang solution</h2>
          <div>
            <a href="https://github.com/airbnb/ts-migrate">TS-migrate</a>
          </div>
          <ul>
            <li>Same than above, but all at once</li>
            <li class="fragment">
              <code>TSFixMe</code> alias of <code>any</code>
            </li>
            <li class="fragment">
              More <code>any</code> and <code>@ts-expect-error</code>
            </li>
          </ul>
        </section>

        <section>
          <h2>Ts-Migrate</h2>
          <div class="fragment">
            <h3>Step 1</h3>
            <p>
              Add a file <code>ts-fixme.d.ts</code> in your source directory
            </p>
            <pre><code data-trim class="typescript">
type $TSFixMe = any;
type $TSFixMeFunction = (...args: any[]) => any;
              </code></pre>
          </div>
          <div class="fragment">
            <h3>step 2</h3>
            <pre><code data-trim class="bash">npm i -D typescript ts-migrate && \
     ts-migrate init . && \
     ts-migrate rename . && \
     ts-migrate --aliases=tsfixme migrate .</code></pre>
          </div>
        </section>
        <section data-transition="none">
          <h2>Ts-migrate example</h2>
          <pre><code data-trim  class="typescript">
class Item {



  constructor(name, sellIn, quality) {
    this.name = name
    this.sellIn = sellIn
    this.quality = quality
  }
}
              </code> </pre>
        </section>

        <section data-transition="none">
          <h2>Ts-migrate example</h2>
          <pre><code data-trim  class="typescript">
// @ts-expect-error TS(2451): Cannot redeclare block-scoped variable 'Item'.
class Item {
  name: $TSFixMe;
  quality: $TSFixMe;
  sellIn: $TSFixMe;
  constructor(name: $TSFixMe, sellIn: $TSFixMe, quality: $TSFixMe) {
    this.name = name
    this.sellIn = sellIn
    this.quality = quality
  }
}
              </code> </pre>
        </section>

        <section>
          <h2>lenient TS to strict TS</h2>

          <ul>
            <li class="fragment">Remove <code>any</code></li>
            <li class="fragment">
              More strict configuration (<code>strictNullChecks</code>,
              <code>noImplicitAny</code>, etc.)
            </li>
          </ul>
        </section>

       <!-- <section>
          <h2>Why do we want to remove implicit <code>any</code>s?</h2>
          <pre><code data-trim class="typescript">
function getAge(a) {  // a is implicitly any
    return Math.floor(
      (Date.now() - new Date(a.birthDate).getTime()
    ) / (86400 * 1000))
}
getName({birthdate: '2021-12-17'}) // returns NaN
            </code></pre>
        </section>-->

        <section>
          <h2>Guess the type</h2>
          <pre><code data-trim class="javascript">
function doSomething(n) { // n is implicitly any
    return Number.parseInt(n);
}

doSomething('123');
            </code></pre>
          <p>What's the type of <code>n</code>?</p>
          <ul>
            <li class="fragment">
              <code>n</code> is used in <code>Number.parseInt</code>:
              <code>n</code>is a sub-type of <code>string</code>
            </li>
            <li class="fragment">
              <code>doSomething</code> is called with <code>'123'</code>:
              <code>n</code>is a super-type of <code>'123'</code>
            </li>
            <li class="fragment">...</li>
            <li class="fragment">type of <code>n</code> is <code>'123'</code></li>
          </ul>
        </section>

        <section>
          <h2>Guess the type</h2>
          <pre><code data-trim class="javascript">
let c; // c is implicitly any
beforeEach(() => {
  c = { name: 'Georges' }
  c.name = 'Peter';
});
            </code></pre>
          <p>What's the type of <code>c</code>?</p>
          <ul>
            <li class="fragment">
              <code>c</code> is set with <code>{name: 'Georges'}</code>:
              <code>c</code>is a super-type of <code>{name: 'Georges'}</code>
            </li>
            <li class="fragment">
              <code>c.name</code> is set with <code>'Peter'</code>:
              <code>c</code>is a sub-type of
              <code>{name: unknown}</code>
              <span class="fragment">
                AND a super-type of <code>{name: 'Peter'}</code></span
              >
            </li>

            <li class="fragment">
              type of <code>c</code> is <code>{name: 'Georges' | 'Peter'}</code>
            </li>
          </ul>
        </section>

        <section>
          <h2>How do you know which type to use instead of any?</h2>
          <div class="fragment">
            <h3>Use an unification approach</h3>
            <img
              style="width: 400px"
              alt="rules for hindley milner algorithm"
              src="img/hindley-milner.png"
            />
          </div>
          <!--
          <h3 class="fragment" style="font-size: 90%">
            The slide full of theory you should forget
          </h3>
          <ul>
            <li class="fragment">Use an unification approach</li>
            <li class="fragment">
              <div>look at Hindley-Milner for more information</div>
              <div style="text-align: center">
                <img
                  style="width: 400px"
                  alt="rules for hindley milner algorithm"
                  src="img/hindley-milner.png"
                />
              </div>
            </li>
          </ul>
            -->
        </section>

        <section>
          <h2>ts-remove-any</h2>
          <a href="https://github.com/blemoine/ts-remove-any"
            >https://github.com/blemoine/ts-remove-any</a
          >
          <pre><code>npx ts-remove-any</code></pre>
          <div class="fragment">
            <p>Remove the <em>explicit</em> <code>any</code></p>
            <pre><code>npx ts-remove-any -e</code></pre>
          </div>
        </section>

        <section>
          <h2>ts-remove-any</h2>
          <ul>
            <li>Won't remove all <code>any</code>s</li>
            <li>Some compilations errors may slip</li>
            <li>Help the migration, won't do it in your stead</li>
          </ul>
        </section>

        <section>
          <h2>ts-remove-any</h2>
          <p>Contributions are welcomed</p>
          <ul>
            <li class="fragment">Code</li>
            <li class="fragment">missing use cases</li>
          </ul>
        </section>

        <section data-transition="none">
          <h2>Ad-Hoc type</h2>
          <pre><code data-trim class="javascript">
function doSomething(
  input
) {
    const output = input.getById(1 + input.ts);
    return output;
}
            </code></pre>
        </section>
        <section data-transition="none">
          <h2>Ad-Hoc type</h2>
          <pre><code data-trim class="typescript">
function doSomething&lt;T>(
  input: {getById: (id: number) => T, ts: number}
):T {
    const output = input.getById(1 + input.ts);
    return output;
}
            </code></pre>
        </section>

        <section>
          <h2>Can't ChatGPT do this?</h2>
          <ul>
            <li>
              ChatGPT is able to remove the <code>any</code> with a well crafted
              prompt
            </li>
            <li class="fragment">
              it's even better than <code>ts-remove-any</code> on some corner
              case
            </li>
            <li class="fragment">
              <em>but</em> it's not able to load a context of 1000s of files
            </li>
            <li class="fragment">
              And your company may not be happy for you to send all your code to
              ChatGPT
            </li>
          </ul>
        </section>

        <section>
          <h2>
            Ensuring nobody's else is re-adding errors when a file is fixed?
          </h2>
        </section>

        <section>
          <h2>Double tsconfig solution</h2>
          <ul>
            <li class="fragment">
              Create a 2nd conf file (eg.<code>tsconfig.strict.json</code>)
            </li>
            <li class="fragment">
              Extends the original file <code> "extends": "./tsconfig"</code>
            </li>
            <li class="fragment">
              Add <code>"noEmit":true</code> and <code>"include": []</code>
            </li>
            <li class="fragment">
              Add <code>"strict":true</code> (or any other options)
            </li>
            <li class="fragment">
              Add file you upgrade to <code>includes</code> when you upgrade
              them
            </li>
            <li class="fragment">
              Add <code>tsc -p tsconfig.strict.json</code> in the CI
            </li>
          </ul>
        </section>

        <section>
          <h2>Finishing the migration?</h2>
          <ul>
            <li>It takes time (weeks, months...)</li>
            <li class="fragment">
              Keep a steady effort (do <code>n</code> files per day, every day!)
            </li>
            <li class="fragment">it's worth the price</li>
          </ul>
        </section>

        <section>
          <h2>Conclusion</h2>
          <ul>
            <li>Not that difficult...</li>
            <li>...but takes a continuous effort</li>
          </ul>
        </section>

        <section>
          <h2>Questions?</h2>
          <a href="https://blemoine.github.io/js-to-ts-prez/"
            >https://blemoine.github.io/js-to-ts-prez/</a
          >
        </section>
      </div>
    </div>

    <script src="dist/reveal.js"></script>
    <script src="plugin/notes/notes.js"></script>
    <script src="plugin/markdown/markdown.js"></script>
    <script src="plugin/highlight/highlight.js"></script>
    <script>
      // More info about initialization & config:
      // - https://revealjs.com/initialization/
      // - https://revealjs.com/config/
      Reveal.initialize({
        hash: true,

        // Learn about plugins: https://revealjs.com/plugins/
        plugins: [RevealMarkdown, RevealHighlight, RevealNotes],
      });
    </script>
  </body>
</html>
